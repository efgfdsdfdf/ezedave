<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home | Student Companion</title>

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="../assets/css/black_theme.css">

  <!-- PWA -->
  <link rel="manifest" href="../assets/pwa/manifest.json">
  <meta name="theme-color" content="#7b61ff">
</head>
<body>

  <!-- Greeting -->
  <div id="userGreet" class="user-greet" >Hi, Guest</div>


  <div class="ai-layout">
    <!-- ğŸ“ Sidebar -->
    <aside id="sidebar" class="sidebar">
      <br><div class="sidebar-header"><br>
        <header></header><br>
       <br><a href="notes.html">Notes</a><br>
       <br><a href="timetable.html">Timetable</a><br>
       <br><a href="gpa.html">GPA</a><br>
       <br><a href="profile.html">Profile</a><br>
       <br><a href="#" id="logoutBtn">Logout</a><br>
       <header></header><br>
      </div>
      <ul id="chat-list" class="chat-list"></ul>
    </aside>

    <!-- ğŸ§± Main Chat Area -->
    <div class="ai-container">
      <header>
        <button id="toggleSidebar" class="toggle-btn">â˜°</button>
        <h1>Student Companion </h1>
      </header>

  <main class="container card" style="max-width:1200px; margin:40px auto; padding:24px; display:flex; flex-direction:column; gap:40px;">

    <h1 id="welcomeMsg" style="text-align:center; font-size:2.2em;">Welcome ğŸ‘‹</h1>

    <div class="intro-message" style="text-align:center; font-size:1.2em;">
      <p>
        ğŸ“ <b>Student Companion</b> helps you stay organized with your
        <span class="highlight">Notes</span>,
        <span class="highlight">Timetable</span>, and
        <span class="highlight">GPA tracker</span>.
      </p>
    </div>
     <head><h1>   Progress Bars <progress></progress>  <header></header></h1></head>
    
    <section class="dashboard-section" style="display:flex; justify-content:space-between; gap:20px;">
      <div class="progress-item" style="flex:1;">
        <h2>ğŸ“ Notes</h2>
        <div class="progress-bar">
          <div id="notesProgress" class="progress-fill"></div>
          <span id="notesCountDisplay">0</span>
        </div>
      </div>

      <div class="progress-item" style="flex:1;">
        <h2>ğŸ“… Timetable</h2>
        <div class="progress-bar">
          <div id="classProgress" class="progress-fill"></div>
          <span id="classCountDisplay">0</span>
        </div>
      </div>

      <div class="progress-item" style="flex:1;">
        <h2>ğŸ“ GPA</h2>
        <div class="progress-bar">
          <div id="gpaProgress" class="progress-fill"></div>
          <span id="gpaCountDisplay">0.0</span>
        </div>
      </div>
    </section>

    <section class="notifications" style="text-align:center;">
      <h2>ğŸ”” Notifications</h2>
      <ul id="homeNotifications" style="list-style:none; padding:0;"></ul>
      <button onclick="requestNotificationPermission()" style="margin-top:16px;">Enable Notifications</button>
    </section>

  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('currentUser') || 'Guest';
      document.getElementById('userGreet').textContent = `Hi, ${username}`;
      document.getElementById('welcomeMsg').textContent = `Welcome, ${username} ğŸ‘‹`;

      // Try to read per-user data from the consolidated `users` object (preferred),
      // otherwise fall back to older top-level keys for backward compatibility.
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const userData = users[username] || {};

      const notes = Array.isArray(userData.notes) ? userData.notes : JSON.parse(localStorage.getItem('notes') || '[]');
      const timetable = Array.isArray(userData.timetable) ? userData.timetable : JSON.parse(localStorage.getItem('timetable') || '[]');
      // gpa in users is stored as 'gpa' (array). old key was 'gpaRecords'.
      const gpaRecords = Array.isArray(userData.gpa) ? userData.gpa : JSON.parse(localStorage.getItem('gpaRecords') || '[]');
      const notifications = Array.isArray(userData.notifications) ? userData.notifications : JSON.parse(localStorage.getItem('homeNotifications') || '[]');

      const notesCount = notes.length;
      const classCount = timetable.length;
      // Compute GPA average. gpaRecords may be either an array of numbers (legacy) or
      // an array of course objects {name, grade, units} used elsewhere in the app.
      let gpaAverage = 0;
      if (gpaRecords.length === 0) gpaAverage = 0;
      else if (typeof gpaRecords[0] === 'number' || !gpaRecords[0].grade) {
        // numeric array
        gpaAverage = gpaRecords.reduce((a,b) => a + Number(b || 0), 0) / gpaRecords.length;
      } else {
        // array of course objects with grade letters and units â€” compute weighted average
        const gradePoints = { A:5, B:4, C:3, D:2, E:1, F:0 };
        let totalUnits = 0, totalPoints = 0;
        gpaRecords.forEach(c => {
          const units = Number(c.units) || 0;
          const grade = (c.grade || '').toString().toUpperCase();
          const points = gradePoints[grade] !== undefined ? gradePoints[grade] : Number(c.grade) || 0;
          totalUnits += units;
          totalPoints += points * units;
        });
        gpaAverage = totalUnits > 0 ? (totalPoints / totalUnits) : 0;
      }

      // Define sensible maxima for the progress bars
      const maxNotes = 100, maxClasses = 100, maxGPA = 5;

      const animateBarWithNumber = (barId, numberId, currentValue, maxValue, decimal=false) => {
        const bar = document.getElementById(barId);
        const number = document.getElementById(numberId);
        if (!bar || !number) return;
        let width = 0, count = 0;
        const targetWidth = Math.min(100, (currentValue / maxValue) * 100);
        const steps = 50;
        const interval = setInterval(() => {
          width += targetWidth / steps;
          if (width >= targetWidth) {
            width = targetWidth;
            bar.style.width = width + '%';
            number.textContent = decimal ? currentValue.toFixed(2) : Math.floor(currentValue);
            clearInterval(interval);
          } else {
            bar.style.width = width + '%';
            count += currentValue / steps;
            number.textContent = decimal ? count.toFixed(2) : Math.floor(count);
          }
        }, 12);
      };

      // Animate with the real counts
      animateBarWithNumber('notesProgress','notesCountDisplay', notesCount, maxNotes);
      animateBarWithNumber('classProgress','classCountDisplay', classCount, maxClasses);
      animateBarWithNumber('gpaProgress','gpaCountDisplay', gpaAverage, maxGPA, true);

      // Render notifications
      const list = document.getElementById('homeNotifications');
      if (list) {
        list.innerHTML = '';
        (notifications || []).forEach(n => {
          const li = document.createElement('li');
          li.textContent = n;
          list.appendChild(li);
        });
      }

      window.requestNotificationPermission = function() {
        if(!("Notification" in window)) return alert("Browser does not support notifications.");
        Notification.requestPermission().then(permission => {
          if(permission === "granted") {
            new Notification(`Hello, ${username}!`, { body: "Welcome back to Student Companion ğŸ“" });
          }
        });
      };

      const logoutBtnEl = document.getElementById('logoutBtn');
      if (logoutBtnEl) {
        logoutBtnEl.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('currentUser');
          window.location.href = "index.html";
        });
      }
    });
  </script>
   <script src="script.js"></script>
    <a href="ai.html" class="floating-ai">ğŸ¤–</a>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("../assets/pwa/sw.js")
      .catch(e => console.warn("SW registration failed", e));
    }

      // ====== USER & LOGOUT ======
  function getCurrentUser() { return localStorage.getItem("currentUser"); }
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.addEventListener("click", () => {
    if(confirm("Logout now?")){
      localStorage.removeItem("currentUser");
      window.location.href = "index.html";
    }
  });

  </script>
  <footer>
    
  </footer>
</body>
</html>
